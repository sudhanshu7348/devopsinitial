#!groovy
def PROJECT_VERSION ='1.0.0'
def ARTIFACT_NAME ='traefik-forward-auth'

pipeline{
    agent none
    environment {
        HC_ARTIFACTORY = credentials('dtt_artifactory_credentials')
        DOCKER_REGISTRY = "hc-us-east-aws-artifactory.cloud.health.ge.com"
        DOCKER_REPO ="docker-dtt-preprod"
    }
    stages{
        stage('Build and Push Image') {
            agent { label 'swarm_worker' }
            steps {
                sh  """
                    #!/bin/bash
                    docker build -t ${DOCKER_REGISTRY}/${DOCKER_REPO}/${ARTIFACT_NAME}:${PROJECT_VERSION} .
                    docker tag ${DOCKER_REGISTRY}/${DOCKER_REPO}/${ARTIFACT_NAME}:${PROJECT_VERSION} ${DOCKER_REGISTRY}/${DOCKER_REPO}/${ARTIFACT_NAME}:latest
                    docker login --username ${HC_ARTIFACTORY_USR} --password ${HC_ARTIFACTORY_PSW} ${DOCKER_REGISTRY}          
                    docker push ${DOCKER_REGISTRY}/${DOCKER_REPO}/${ARTIFACT_NAME}:${PROJECT_VERSION}
                    docker push ${DOCKER_REGISTRY}/${DOCKER_REPO}/${ARTIFACT_NAME}:latest
                    docker logout
                    """
                cleanWs()
		    }
        }
    }
}
